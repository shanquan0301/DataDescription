View(share_dat)
View(hse)
#dat_final----
hse$country <- "UK"
dat_final <- bind_rows(share_dat, hse)
dat_final <- dat_final %>% group_by(country) %>% 
  mutate(start = year == min(year),
         wealth = as.factor(wealth),
         start = factor(start, levels = c(TRUE, FALSE))) %>% 
  ungroup()
mdat_1 <- dat_final %>% filter(country != "UK" )
mdat_1 <- mdat_1 %>% mutate(
  age_c = case_when(
    between(age, 22, 64) ~ "50-64",
    between(age, 65, 2000) ~ "65+"
  )
)

mdat_2 <- dat_final %>% filter(country == "UK" & year == 2014)
mdat_2 <- mdat_2 %>% mutate(
  age_c = case_when(
    between(age, 13, 19) ~ "13-19",
    between(age, 20, 24) ~ "20-24",
    between(age, 25, 49) ~ "25-49",
    between(age, 50, 64) ~ "50-64",
    between(age, 65, 2000) ~ "65+"
  )
)

mdat_3 <- dat_final %>% filter(country == "UK" & year == 2018)
mdat_3 <- mdat_3 %>% mutate(
  age_c = case_when(
    between(age, 6, 7) ~ "13-19",
    between(age, 8, 8) ~ "20-24",
    between(age, 9, 13) ~ "25-49",
    between(age, 14, 16) ~ "50-64",
    between(age, 17, 2000) ~ "65+"
  )
)

dat_final <- bind_rows(mdat_1, mdat_2, mdat_3)
#dat_final <- dat_final
dat_final$depression[dat_final$mental_medicine] <- TRUE
dat_final$depression[is.na(dat_final$depression)] <- FALSE
#dat_final$depression[is.na(dat_final$depression)] <- FALSE
#proportion of depression<<<<<<<<<<<<<<<<<----------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

res_depression <- bind_rows(res_start, res_end)
res_depression <- res_depression %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

#on gender, res_depression_gender--------

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, gender == "Male", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, gender == "Male", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$gender <- "Male"

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, gender == "Female", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, gender == "Female", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$gender <- "Female"

res_depression_gender <- bind_rows(mdat_1, mdat_2)

#on wealth, res_depression_wealth----------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 1, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 1, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$wealth <- 1

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 2,  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 2, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$wealth <- 2

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 3,  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 3, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_3 <- bind_rows(res_start, res_end)
mdat_3 <- mdat_3 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_3$wealth <- 3

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 4,  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 4, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_4 <- bind_rows(res_start, res_end)
mdat_4 <- mdat_4 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_4$wealth <- 4

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 5,  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 5, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_5 <- bind_rows(res_start, res_end)
mdat_5 <- mdat_5 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_5$wealth <- 5




res_depression_wealth <- bind_rows(mdat_1, mdat_2, mdat_3, mdat_4, mdat_5)





#on difficult, res_depression_diff--------

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, difficult_yes == TRUE, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, difficult_yes == TRUE, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$difficult_yes<- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, difficult_yes == FALSE, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, difficult_yes == FALSE, country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$difficult_yes <- FALSE

res_depression_diff <- bind_rows(mdat_1, mdat_2)

#on age, res_depression_age------

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "50-64", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "50-64",  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$age_c <- "50-64" 

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "65+", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "65+",  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$age_c <- "65+"

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "13-19", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_start <- res}
}
res_start$start <- TRUE

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "13-19",  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_end <- res}
}
res_end$start <- FALSE

mdat_3 <- bind_rows(res_start, res_end)
mdat_3 <- mdat_3 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_3$age_c <- "13-19" 

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "20-24", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_start <- res}
}
res_start$start <- TRUE

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "20-24",  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_end <- res}
}
res_end$start <- FALSE

mdat_4 <- bind_rows(res_start, res_end)
mdat_4 <- mdat_4 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_4$age_c <- "20-24" 

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "25-49", country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_start <- res}
}
res_start$start <- TRUE

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "25-49",  country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~depression, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_end <- res}
}
res_end$start <- FALSE

mdat_5 <- bind_rows(res_start, res_end)
mdat_5 <- mdat_5 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_5$age_c <- "25-49" 


res_depression_age <- bind_rows(mdat_1, mdat_2, mdat_3, mdat_4, mdat_5)
#result on year, coef_year<<<<<<<<<<<<-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ start, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
                  )
  res$country <- i
  if (i == "Austria") {coef_dat <- res}
  if (i != "Austria") {coef_dat <- bind_rows(coef_dat, res)}
  coef_dat <- coef_dat %>% filter(str_detect(variable, "start"))
}
coef_dat <- coef_dat %>% select(coef, ci_low, ci_high, comb_ci, p_value, country)

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ start + age_c + gender + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_ad <- res}
  if (i != "Austria") {coef_ad <- bind_rows(coef_ad, res)}
  coef_ad <- coef_ad %>% filter(str_detect(variable, "start"))
}
coef_ad <- coef_ad %>% select(coef_ad = coef,
                              ci_low_ad = ci_low,
                              ci_high_ad = ci_high,
                              comb_ci_ad = comb_ci,
                              p_value_ad = p_value,
                              country)
coef_year <- left_join(coef_dat, coef_ad)


#sub gender, coef_gender-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_gender <- res}
  if (i != "Austria") {coef_gender <- bind_rows(coef_gender, res)}
  coef_gender <- coef_gender %>% filter(str_detect(variable, "gender"))
}
coef_gender_m <- coef_gender

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender*start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_gender <- res}
  if (i != "Austria") {coef_gender <- bind_rows(coef_gender, res)}
  coef_gender <- coef_gender %>% filter(str_detect(variable, "gender"), str_detect(variable, "start"))
}
coef_gender <- bind_rows(coef_gender_m, coef_gender)


#sub wealth, coef_wealth-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender + wealth + start + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_wealth <- res}
  if (i != "Austria") {coef_wealth <- bind_rows(coef_wealth, res)}
  coef_wealth <- coef_wealth %>% filter(str_detect(variable, "wealth"))
}
coef_wealth_m <- coef_wealth

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender + wealth*start + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_wealth <- res}
  if (i != "Austria") {coef_wealth <- bind_rows(coef_wealth, res)}
  coef_wealth <- coef_wealth %>% filter(str_detect(variable, "wealth"), str_detect(variable, "start"))
}
coef_wealth <- bind_rows(coef_wealth_m, coef_wealth)

#sub difficult, coef_diff-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_diff <- res}
  if (i != "Austria") {coef_diff <- bind_rows(coef_diff, res)}
  coef_diff <- coef_diff %>% filter(str_detect(variable, "difficult_yes"))
}
coef_diff_m <- coef_diff

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender + wealth + difficult_yes*start, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_diff <- res}
  if (i != "Austria") {coef_diff <- bind_rows(coef_diff, res)}
  coef_diff <- coef_diff %>% filter(str_detect(variable, "difficult_yes"), str_detect(variable, "start"))
}
coef_diff <- bind_rows(coef_diff_m, coef_diff)





#sub age, coef_age-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_age <- res}
  if (i != "Austria") {coef_age <- bind_rows(coef_age, res)}
  coef_age <- coef_age %>% filter(str_detect(variable, "age"))
}
coef_age_m <- coef_age

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(depression ~ age_c*start + gender + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_age <- res}
  if (i != "Austria") {coef_age <- bind_rows(coef_age, res)}
  coef_age <- coef_age %>% filter(str_detect(variable, "age"), str_detect(variable, "start"))
}
coef_age <- bind_rows(coef_age_m, coef_age)





#proportion of medicine, res_medicine<<<<<<<<<<<<<---------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start_1 <- res}
  if (i != "Austria") {res_start_1 <- bind_rows(res_start_1, res)}
}
res_start_1$depression <- TRUE
res_start_1$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, country == i, depression == FALSE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start_2 <- res}
  if (i != "Austria") {res_start_2 <- bind_rows(res_start_2, res)}
}
res_start_2$depression <- FALSE
res_start_2$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end_1 <- res}
  if (i != "Austria") {res_end_1 <- bind_rows(res_end_1, res)}
}
res_end_1$depression <- TRUE
res_end_1$start <- FALSE


for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, country == i, depression == FALSE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end_2 <- res}
  if (i != "Austria") {res_end_2 <- bind_rows(res_end_2, res)}
}
res_end_2$depression <- FALSE
res_end_2$start <- FALSE

res_medicine <- bind_rows(res_start_1, res_start_2,
                          res_end_1, res_end_2)
res_medicine <- res_medicine%>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

#on gender, res_mental_medicine_gender--------

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, gender == "Male", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, gender == "Male", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$gender <- "Male"

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, gender == "Female", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, gender == "Female", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$gender <- "Female"

res_medicine_gender <- bind_rows(mdat_1, mdat_2)

#on wealth, res_mental_medicine_wealth----------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 1, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 1, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$wealth <- 1

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 2,  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 2, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$wealth <- 2

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 3,  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 3, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_3 <- bind_rows(res_start, res_end)
mdat_3 <- mdat_3 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_3$wealth <- 3

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 4,  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 4, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_4 <- bind_rows(res_start, res_end)
mdat_4 <- mdat_4 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_4$wealth <- 4

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, wealth == 5,  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, wealth == 5, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_5 <- bind_rows(res_start, res_end)
mdat_5 <- mdat_5 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_5$wealth <- 5




res_medicine_wealth <- bind_rows(mdat_1, mdat_2, mdat_3, mdat_4, mdat_5)





#on difficult, res_mental_medicine_diff--------

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, difficult_yes == TRUE, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, difficult_yes == TRUE, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$difficult_yes<- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, difficult_yes == FALSE, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, difficult_yes == FALSE, country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$difficult_yes <- FALSE

res_medicine_diff <- bind_rows(mdat_1, mdat_2)

#on age, res_medicine_age------

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "50-64", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "50-64",  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_1 <- bind_rows(res_start, res_end)
mdat_1 <- mdat_1 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_1$age_c <- "50-64" 

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "65+", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_start <- res}
  if (i != "Austria") {res_start <- bind_rows(res_start, res)}
}
res_start$start <- TRUE

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "65+",  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "Austria") {res_end <- res}
  if (i != "Austria") {res_end <- bind_rows(res_end, res)}
}
res_end$start <- FALSE

mdat_2 <- bind_rows(res_start, res_end)
mdat_2 <- mdat_2 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_2$age_c <- "65+"

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "13-19", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_start <- res}
}
res_start$start <- TRUE

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "13-19",  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_end <- res}
}
res_end$start <- FALSE

mdat_3 <- bind_rows(res_start, res_end)
mdat_3 <- mdat_3 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_3$age_c <- "13-19" 

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "20-24", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_start <- res}
}
res_start$start <- TRUE

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "20-24",  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_end <- res}
}
res_end$start <- FALSE

mdat_4 <- bind_rows(res_start, res_end)
mdat_4 <- mdat_4 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_4$age_c <- "20-24" 

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == TRUE, age_c == "25-49", country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_start <- res}
}
res_start$start <- TRUE

for (i in c("UK")){
  print(i)
  mdat <- dat_final %>% filter(start == FALSE, age_c == "25-49",  country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  res <- svyciprop(~mental_medicine, design=my_design)
  res <- data.frame(t(c(as.vector(res), confint(res), i)))
  names(res) <- c("mean", "low", "high", "country")
  if (i == "UK") {res_end <- res}
}
res_end$start <- FALSE

mdat_5 <- bind_rows(res_start, res_end)
mdat_5 <- mdat_5 %>% mutate(
  mean = as.numeric(as.character(mean)) * 100,
  low = as.numeric(as.character(low)) * 100,
  high = as.numeric(as.character(high)) * 100,
)

mdat_5$age_c <- "25-49" 


res_medicine_age <- bind_rows(mdat_1, mdat_2, mdat_3, mdat_4, mdat_5)
#result on year, coef_med_year<<<<<<<<<<<<<<<-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ start, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med <- res}
  if (i != "Austria") {coef_med <- bind_rows(coef_med, res)}
  coef_med <- coef_med %>% filter(str_detect(variable, "start"))
}
coef_med <- coef_med %>% select(coef, ci_low, ci_high, comb_ci, p_value, country)

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ start + age_c + gender + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_ad <- res}
  if (i != "Austria") {coef_med_ad <- bind_rows(coef_med_ad, res)}
  coef_med_ad <- coef_med_ad %>% filter(str_detect(variable, "start"))
}
coef_med_ad <- coef_med_ad %>% select(coef_ad = coef,
                                      ci_low_ad = ci_low,
                                      ci_high_ad = ci_high,
                                      comb_ci_ad = comb_ci,
                                      p_value_ad = p_value,
                                      country)
coef_med_year <- left_join(coef_med, coef_med_ad)

#sub gender,coef_med_gender -------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_gender <- res}
  if (i != "Austria") {coef_med_gender <- bind_rows(coef_med_gender, res)}
  coef_med_gender <- coef_med_gender %>% filter(str_detect(variable, "gender"))
}
coef_med_gender_m <- coef_med_gender 


for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender*start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_gender <- res}
  if (i != "Austria") {coef_med_gender <- bind_rows(coef_med_gender, res)}
  coef_med_gender <- coef_med_gender %>% filter(str_detect(variable, "gender"), str_detect(variable, "start"))
}
coef_med_gender <- bind_rows(coef_med_gender_m, coef_med_gender)




#sub wealth,coef_med_wealth-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_wealth <- res}
  if (i != "Austria") {coef_med_wealth <- bind_rows(coef_med_wealth, res)}
  coef_med_wealth <- coef_med_wealth %>% filter(str_detect(variable, "wealth"))
}
coef_med_wealth_m <- coef_med_wealth 


for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender + start * wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_wealth <- res}
  if (i != "Austria") {coef_med_wealth <- bind_rows(coef_med_wealth, res)}
  coef_med_wealth <- coef_med_wealth %>% filter(str_detect(variable, "wealth"), str_detect(variable, "start"))
}
coef_med_wealth <- bind_rows(coef_med_wealth_m, coef_med_wealth)
























#sub difficult,coef_med_diff-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_diff <- res}
  if (i != "Austria") {coef_med_diff <- bind_rows(coef_med_diff, res)}
  coef_med_diff <- coef_med_diff %>% filter(str_detect(variable, "difficult_yes"))
}
coef_med_diff_m <- coef_med_diff 


for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender + wealth + difficult_yes*start, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_diff <- res}
  if (i != "Austria") {coef_med_diff <- bind_rows(coef_med_diff, res)}
  coef_med_diff <- coef_med_diff %>% filter(str_detect(variable, "difficult_yes"), str_detect(variable, "start"))
}
coef_med_diff <- bind_rows(coef_med_diff_m, coef_med_diff)




#sub age, coef_med_age-------------
for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  if(i == "UK") {
    mdat$age_c <- factor(mdat$age_c, levels = c("50-64", "13-19", "20-24", "25-49", "65+"))
  }
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c + gender + start + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_age <- res}
  if (i != "Austria") {coef_med_age <- bind_rows(coef_med_age, res)}
  coef_med_age <- coef_med_age %>% filter(str_detect(variable, "age"))
}
coef_med_age_m <- coef_med_age

for (i in unique(dat_final$country)){
  print(i)
  mdat <- dat_final %>% filter(country == i, depression == TRUE)
  if(i == "UK") {
    mdat$age_c <- factor(mdat$age_c, levels = c("50-64", "13-19", "20-24", "25-49", "65+"))
  }
  my_design <- svydesign(id=~1, weights=~weight, data=mdat)
  reg <- svyglm(mental_medicine ~ age_c*start + gender + wealth + difficult_yes, design = my_design, family = binomial())
  res <- reg_comb(reg = reg, data = NULL,
                  exp_transfer = TRUE, 
                  p_value = "`Pr(>|t|)`",
                  round_ci = 2,
                  round_p = 3,
                  comb_ci = "coef(ci_low, ci_high)star"
  )
  res$country <- i
  if (i == "Austria") {coef_med_age <- res}
  if (i != "Austria") {coef_med_age <- bind_rows(coef_med_age, res)}
  coef_med_age <- coef_med_age %>% filter(str_detect(variable, "age"), str_detect(variable, "start"))
}
coef_med_age <- bind_rows(coef_med_age_m, coef_med_age)





#plot depression<<<<<<<<<<--------
mdat <- res_depression %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level <- as.character(mdat$country[mdat$start == "End"])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level))

plot_1 <- ggplot(data = mdat, aes(x = mean, y = country, colour = start)) +
  geom_point() +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(expand = c(0.01, 0.1), 
                     limits = c(0, seq(0, 100, by = 5)[seq(0, 100, by = 5) - max(mdat$high) >0][1])) + 
  ggtitle("  ") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))



# mdat_1 <- res_depression %>% filter(start == TRUE) %>% 
#   mutate(x = mean) %>% 
#   select(country, x)
# mdat_2 <- res_depression %>% filter(start == FALSE) %>% 
#   mutate(xend = mean) %>% 
#   select(country, xend)
# mdat <- left_join(mdat_1, mdat_2)
# mdat <- mdat %>% arrange(xend)
# #country_level <- as.character(mdat$country)
# mdat<- mdat %>% 
#   mutate(country = factor(country, levels = country_level))
# 
# plot_1 <- ggplot(data = mdat) + 
#   geom_segment(aes(x = x, y = country, xend = xend, yend = country),
#                arrow = arrow(length = unit(0.2,"cm"))) + 
#   ggtitle("Percentage of depression") + 
#   theme_classic() + 
#   theme(panel.grid.major.y = element_line(linetype = 2),
#         axis.title = element_blank(),
#         plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  labs(x = "") + 
  ggtitle("Start to end") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_year
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level))

plot_3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  labs(x = "") + 
  ggtitle("OR (95%CI)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

plot_4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci_ad)) + 
  labs(x = "") + 
  ggtitle("Adjusted OR (95%CI)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, plot_3, plot_4,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 1, 
                                      2, 3, 4), nrow = 1))

#14.8, 7.8

#plot gender-----------
mdat <- res_depression_gender %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level_gender <- as.character(mdat$country[mdat$start == "End" & mdat$gender == "Female"])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_gender))

plot_1 <- ggplot(data = mdat, aes(x = mean, y = country, colour = start)) +
  geom_point(aes(shape = gender)) +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(expand = c(0.01, 0.1), 
                     name = "% with depression symptoms receiving antidepressants",
                     limits = c(0, seq(0, 100, by = 5)[seq(0, 100, by = 5) - max(mdat$high) >0][1])) + 
  ggtitle("  ") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_gender))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  ggtitle("Start to end") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_gender %>% filter(!str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_gender))

plot_3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (1)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_gender %>% filter(str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_gender))

plot_4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (2)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, plot_3, plot_4,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 
                                      2, 3, 4), nrow = 1))

#14.8, 7.8



#plot wealth-----------
mdat <- res_depression_wealth %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level_wealth <- as.character(mdat$country[mdat$start == "End" & mdat$wealth == 1])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_1 <- ggplot(data = mdat, aes(x = mean, y = country, colour = start)) +
  geom_point(aes(shape = factor(wealth))) +
  #geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(expand = c(0.01, 0.1), limits = c(0, 75)) + 
  ggtitle("Percentage of depression") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  ggtitle("Start to end") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_wealth %>% filter(!str_detect(variable, "start"), variable == "wealth2") 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_3.2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (1)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

mdat <- coef_wealth %>% filter(!str_detect(variable, "start"), variable == "wealth3") 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_3.3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (1)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

mdat <- coef_wealth %>% filter(!str_detect(variable, "start"), variable == "wealth4") 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_3.4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (1)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

mdat <- coef_wealth %>% filter(!str_detect(variable, "start"), variable == "wealth5") 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_3.5 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (1)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_wealth %>% filter(str_detect(variable, "start"),  str_detect(variable, "wealth2")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_4.2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (2)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

mdat <- coef_wealth %>% filter(str_detect(variable, "start"),  str_detect(variable, "wealth3")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_4.3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (2)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

mdat <- coef_wealth %>% filter(str_detect(variable, "start"),  str_detect(variable, "wealth4")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_4.4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (2)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

mdat <- coef_wealth %>% filter(str_detect(variable, "start"),  str_detect(variable, "wealth5")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_wealth))

plot_4.5 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (2)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, 
             plot_3.2, plot_3.3, plot_3.4, plot_3.5, 
             plot_4.2, plot_4.3, plot_4.4, plot_4.5,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 
                                      2:10), nrow = 1))

#14.8, 7.8



#table wealth--------
mdat <- res_depression_wealth %>% rowwise() %>% 
  mutate(comb = str_glue("{round(mean, 2)}({round(low, 2)}, {round(high, 2)})"))

mdat <- mdat %>% select(country, start, wealth, comb) %>% spread(key = "start", value = "comb")

mdat_1 <- coef_wealth %>% filter(!str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "wealth", ""),
         wealth = as.numeric(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, wealth, comb_ci),
                  by = c("country", "wealth"))

mdat_1 <- coef_wealth %>% filter(str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "wealth", ""),
         variable = str_replace_all(variable, ":startFALSE", ""),
         wealth = as.numeric(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, wealth, comb_ci),
                  by = c("country", "wealth"))

write.csv(mdat, "table_depression_wealth.csv")

#table age-------
mdat <- res_depression_age %>% rowwise() %>% 
  mutate(comb = str_glue("{round(mean, 2)}({round(low, 2)}, {round(high, 2)})"))

mdat <- mdat %>% select(country, start, age_c, comb) %>% spread(key = "start", value = "comb")

mdat_1 <- coef_age %>% filter(!str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "age_c", ""),
         age_c = as.character(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, age_c, comb_ci),
                  by = c("country", "age_c"))

mdat_1 <- coef_age %>% filter(str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "age_c", ""),
         variable = str_replace_all(variable, ":startFALSE", ""),
         age_c = as.character(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, age_c, comb_ci),
                  by = c("country", "age_c"))

write.csv(mdat, "table_depression_age.csv")
#plot difficult-----------
mdat <- res_depression_diff %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level_diff <- as.character(mdat$country[mdat$start == "End" & mdat$difficult_yes == TRUE])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_diff))

plot_1 <- ggplot(data = mdat, aes(x = mean, y = country, colour = start)) +
  geom_point(aes(shape = difficult_yes)) +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(expand = c(0.01, 0.1), 
                     limits = c(0, seq(0, 100, by = 5)[seq(0, 100, by = 5) - max(mdat$high) >0][1])) + 
  ggtitle("  ") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_diff))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  ggtitle("Start to end") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_diff %>% filter(!str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_diff))

plot_3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (1)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_diff %>% filter(str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_diff))

plot_4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted 95%CI (2)") + 
  theme_classic() + 
  theme(axis.title = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, plot_3, plot_4,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 
                                      2, 3, 4), nrow = 1))

#14.8, 7.8



#plot medicine<<<<<<<<<<<<<--------
mdat <- res_medicine %>% filter(depression == TRUE) %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level_med <- as.character(mdat$country[mdat$start == "End"])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med))

mdat_reg <- mdat %>% select(mean, country, start) %>% spread(
  key = start, value = mean
)



plot_1 <- ggplot(data = mdat, aes(x = mean, y = country, colour = start)) +
  geom_point() +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(limits = c(0, seq(0, 100, by = 5)[seq(0, 100, by = 5) - max(mdat$high) >0][1]),
                     name = "% with depression symptoms receiving antidepressants",
                     expand = c(0.01, 0.1)) + 
  ggtitle("  ") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))


# mdat_1 <- res_medicine%>% filter(start == TRUE, depression == TRUE) %>% 
#   mutate(x = mean) %>% 
#   select(country, x)
# mdat_2 <- res_medicine %>% filter(start == FALSE, depression == TRUE) %>% 
#   mutate(xend = mean) %>% 
#   select(country, xend)
# mdat <- left_join(mdat_1, mdat_2)
# mdat <- mdat %>% arrange(xend)
# #country_level_med <- mdat$country
# mdat<- mdat %>% 
#   mutate(country = factor(country, levels = country_level))
# 
# plot_1 <- ggplot(data = mdat) + 
#   geom_segment(aes(x = x, y = country, xend = xend, yend = country),
#                arrow = arrow(length = unit(0.2,"cm"))) + 
#   ggtitle("Percentage of medicine") + 
#   theme_classic() + 
#   theme(panel.grid.major.y = element_line(linetype = 2),
#         axis.title = element_blank(),
#         plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  labs(x = "") + 
  ggtitle("Start to end") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_med_year 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med))


plot_3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  labs(x = "") + 
  ggtitle("OR (95CI%)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))

plot_4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci_ad)) + 
  labs(x = "") + 
  ggtitle("Adjusted OR (95CI%)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, plot_3, plot_4,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 1, 1, 1,
                                      2,2, 3,3, 4,4), nrow = 1))

#14.8, 7.8

#plot gender-----------
mdat <- res_medicine_gender %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level_med_gender <- as.character(mdat$country[mdat$start == "End" & mdat$gender == "Female"])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_gender),
         y = as.numeric(country))
mdat <- mdat %>% mutate(
  y2 = ifelse(gender == "Male", y - 0.2, y + 0.2)
)


plot_1 <- ggplot(data = mdat, aes(x = mean, y = y2, colour = start)) +
  geom_point(aes(shape = gender)) +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(expand = c(0.01, 0.1), 
                     name = "% with depression symptoms receiving antidepressants",
                     limits = c(0, seq(0, 100, by = 5)[seq(0, 100, by = 5) - max(mdat$high) >0][1])) + 
  scale_y_continuous(expand = c(0.01, 0.1),
                     breaks = 1:19, labels = levels(mdat$country)) + 
  ggtitle("  ") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_gender))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  ggtitle("Start to end") + 
  labs(x = "") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_med_gender %>% filter(!str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_gender))

plot_3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted OR (95CI%)") + 
  labs(x = "") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_med_gender %>% filter(str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_gender))

plot_4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted OR for trend (95CI%)") + 
  labs(x = "") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, plot_3, plot_4,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 
                                      2, 3, 4, 4), nrow = 1))

#14.8, 7.8





















#table wealth--------
mdat <- res_medicine_wealth %>% rowwise() %>% 
  mutate(comb = str_glue("{round(mean, 2)}({round(low, 2)}, {round(high, 2)})"))

mdat <- mdat %>% select(country, start, wealth, comb) %>% spread(key = "start", value = "comb")

mdat_1 <- coef_med_wealth %>% filter(!str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "wealth", ""),
         wealth = as.numeric(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, wealth, comb_ci),
                  by = c("country", "wealth"))

mdat_1 <- coef_med_wealth %>% filter(str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "startFALSE:wealth", ""),
         wealth = as.numeric(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, wealth, comb_ci),
                  by = c("country", "wealth"))

write.csv(mdat, "table_med_wealth.csv")
#table age-------
mdat <- res_medicine_age %>% rowwise() %>% 
  mutate(comb = str_glue("{round(mean, 2)}({round(low, 2)}, {round(high, 2)})"))

mdat <- mdat %>% select(country, start, age_c, comb) %>% spread(key = "start", value = "comb")

mdat_1 <- coef_med_age %>% filter(!str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "age_c", ""),
         age_c = as.character(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, age_c, comb_ci),
                  by = c("country", "age_c"))

mdat_1 <- coef_med_age %>% filter(str_detect(variable, "start")) %>% 
  mutate(variable = str_replace_all(variable, "age_c", ""),
         variable = str_replace_all(variable, ":startFALSE", ""),
         age_c = as.character(variable))


mdat <- left_join(mdat,
                  mdat_1 %>% select(country, age_c, comb_ci),
                  by = c("country", "age_c"))

write.csv(mdat, "table_med_age.csv")
#plot difficult-----------
mdat <- res_medicine_diff %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ),
  start = factor(start, levels = c("Start", "End"))
  )

mdat <- mdat %>% arrange(mean)
country_level_med_diff <- as.character(mdat$country[mdat$start == "End" & mdat$difficult_yes == TRUE])

mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_diff),
         difficult_yes = factor(difficult_yes, levels = c(FALSE, TRUE), 
                                labels = c("No physical disability", "Physical disability")),
         y = as.numeric(country))
mdat <- mdat %>% mutate(
  y2 = ifelse(difficult_yes == "Physical disability", y - 0.15, y + 0.15)
)


plot_1 <- ggplot(data = mdat, aes(x = mean, y = y2, colour = start)) +
  geom_point(aes(shape = difficult_yes)) +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  scale_colour_manual(values = pal_nejm("default")(8)[c(2, 1)]) +
  scale_x_continuous(expand = c(0.01, 0.1), 
                     name = "% with depression symptoms receiving antidepressants",
                     limits = c(0, seq(0, 100, by = 5)[seq(0, 100, by = 5) - max(mdat$high) >0][1])) + 
  scale_y_continuous(expand = c(0.01, 0.1),
                     breaks = 1:19, labels = levels(mdat$country)) + 
  ggtitle("  ") + 
  theme_classic() + 
  theme(panel.grid.major.y = element_line(linetype = 2),
        axis.title.y = element_blank(),
        plot.title = element_text(hjust = 0.5, face = "bold"),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.2))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- dat_final %>% select(country, year, start) %>% 
  distinct()
mdat <- left_join(mdat %>% filter(start == TRUE),
                  mdat %>% filter(start == FALSE),
                  by = "country")
mdat <- mdat %>% rowwise() %>% 
  mutate(comb = str_glue("{year.x} to {year.y}")) %>% 
  ungroup()
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_diff))

plot_2 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb)) + 
  ggtitle("Start to end") + 
  labs(x = "") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_med_diff %>% filter(!str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_diff))

plot_3 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted OR (95CI%)") + 
  labs(x = "") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))
#~~~~~~~~~~~~~~~~~~~~~~~~~

mdat <- coef_med_diff %>% filter(str_detect(variable, "start")) 
mdat<- mdat %>% 
  mutate(country = factor(country, levels = country_level_med_diff))

plot_4 <- ggplot(data = mdat) + 
  geom_text(aes(x= factor(1), y = country, label = comb_ci)) + 
  ggtitle("Adjusted OR for trend (95CI%)") + 
  labs(x = "") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1, plot_2, plot_3, plot_4,
             layout_matrix = matrix(c(1, 1, 1, 1, 1, 
                                      2, 3, 4, 4), nrow = 1))

#14.8, 7.8





















#country-pevel----------------
dat_psy <- read_excel("C:/Users/shanquan/Dropbox/Mental health in Europe/results.xlsx", sheet = "psy")

mdat <- res_medicine %>% filter(depression == TRUE) %>% 
  mutate(start = case_when(
    start == TRUE ~ "Start",
    start == FALSE ~ "End"
  ))

dat_reg <- left_join(mdat, dat_psy, by = c("country", "start"))
dat_reg <- dat_reg %>%
  mutate(start = factor(start, levels = c("Start", "End")))

dat_reg_1 <- dat_reg %>% filter(start == "Start")
dat_reg_2 <- dat_reg %>% filter(start == "End")
dat_reg_diff <- dat_reg_2 %>% mutate(
  mean = mean - dat_reg_1$mean,
  psy = psy - dat_reg_1$psy,
  gmp = gmp - dat_reg_1$gmp,
  gp = gp - dat_reg_1$gp,
  ppp = ppp - dat_reg_1$ppp,
  exp_gpd = exp_gpd - dat_reg_1$exp_gpd,
  exp_people = exp_people - dat_reg_1$exp_people,
  bed = bed - dat_reg_1$bed
)
#regression on  psy-----
reg <- lm(mean ~ psy, data = dat_reg_diff)
summary(reg)

res <- dat_reg %$% cor.test(mean, psy, method = "kendall")
tau <- round(res$estimate, 4)

#regression on gmp-----
reg <- lm(mean ~ gmp, data = dat_reg_diff)
summary(reg)

res <- dat_reg %$% cor.test(mean, gmp, method = "kendall")
tau <- round(res$estimate, 4)

#regression on gp-----
reg <- lm(mean ~ gp, data = dat_reg_diff %>% filter(country != "Portugal"))
summary(reg)
dat_reg %$% cor.test(mean,gp, method = "kendall")

#regression on ppp-----
reg <- lm(mean ~ ppp, data = dat_reg_diff)
summary(reg)

dat_reg %$% cor.test(mean, ppp, method = "kendall")

#regression on exp_gdp-----
reg <- lm(mean ~ exp_gdp, data = dat_reg_diff)
summary(reg)
dat_reg %$% cor.test(mean, exp_gpd, method = "kendall")

#regression on exp_people-----
reg <- lm(mean ~ exp_people, data = dat_reg_diff)
summary(reg)
dat_reg %$% cor.test(mean, exp_people, method = "kendall")


#REGRESSION on all----
mdat_1 <- dat_final %>% filter(depression == TRUE) %>% mutate(
  start = ifelse(start == TRUE, "Start", "End")
)
mdat_2 <- dat_reg %>% select(country, start, psy:bed)
mdat <- left_join(mdat_1, mdat_2, by = c("country", "start"))
mdat <- mdat %>% 
  mutate(start = factor(start, levels = c("Start", "End")))
mdat$weight2 <- 1
# my_design <- svydesign(id=~1, weights=~weight2, data=mdat)
# reg <- svyglm(mental_medicine ~ psy + gmp + I(ppp/1000) + exp_gpd + I(bed) + 
#                 start + age_c + gender + wealth + difficult_yes, design = my_design, family = binomial())
# summary(reg)
# 
# reg <- svyglm(mental_medicine ~ psy*start  + gmp*start + I(ppp/1000)*start + exp_gpd*start + I(bed)*start + 
#                 start + age_c + gender + wealth + difficult_yes, design = my_design, family = binomial())
# summary(reg)

reg <- glm(mental_medicine ~ I(-psy/10) + I(-gmp/10) + I(ppp/1000) + exp_gpd + I(-bed/10) + 
             start + age_c + gender + wealth + difficult_yes, 
           family = binomial(),
           data = mdat)
summary(reg)
reg_all <- reg_comb(reg = reg,
                    data = NULL,
                    exp_transfer = TRUE,
                    p_value = "`Pr(>|z|)`",
                    round_ci = 2,
                    comb_ci = "coef(ci_low, ci_high)star")
res_1 <- reg_all[2:6, ]
res_1$variable <- c("Psychiatrists per million inhabitants", 
                    "General practitioners per million inhabitants",
                    "Gross national income per capita (1000 US dollars)",
                    "Public expenditure on health (% of GDP)",
                    "Psychiatric hospital beds in per million inhabitants")
res_1 <- res_1 %>% mutate(
  coef = as.numeric(coef),
  ci_low = as.numeric(ci_low),
  ci_high = as.numeric(ci_high)
)


plot_1.1 <- ggplot(data = res_1, aes(x = coef, y = variable)) + 
  geom_point(shape = 15) + 
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.25) + 
  geom_vline(xintercept = 1, linetype = 2, colour = "grey60") + 
  scale_x_log10(limits = c(0.9, 1.8), breaks = c(0.9, 1, 1.4,  1.8),
                expand = c(0.01, 0.01)) + 
  labs(x = "OR (95% CI)", title = "A") + 
  #ggtitle()
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        #plot.margin = margin(r = 0, unit = "pt"),
        panel.grid.major.y = element_line(linetype = 2, colour = "grey80")) 

plot_1.2 <- ggplot(data = res_1) + 
  geom_text(aes(x= factor(1), y = variable, label = comb_ci)) + 
  labs(x = " ", title = "OR (95% CI)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        #plot.margin = margin(l = 0, unit = "pt"),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


reg <- glm(mental_medicine ~ I(-psy/10)*start + I(-gmp/10)*start + I(ppp/1000)*start + exp_gpd*start + I(-bed/10)*start + 
             start + age_c + gender + wealth + difficult_yes, 
           family = binomial(),
           data = mdat)
summary(reg)
reg_trend <- reg_comb(reg = reg,
                    data = NULL,
                    exp_transfer = TRUE,
                    p_value = "`Pr(>|z|)`",
                    round_ci = 2,
                    comb_ci = "coef(ci_low, ci_high)star")
res_2 <- reg_trend[18:22, ]

res_2$variable <- c("Psychiatrists per million inhabitants", 
                    "General practitioners per million inhabitants",
                    "Gross national income per capita (1000 US dollars)",
                    "Public expenditure on health (% of GDP)",
                    "Psychiatric hospital beds in per million inhabitants")

res_2 <- res_2 %>% mutate(
  coef = as.numeric(coef),
  ci_low = as.numeric(ci_low),
  ci_high = as.numeric(ci_high)
)

plot_2.1 <- ggplot(data = res_2, aes(x = coef, y = variable)) + 
  geom_point(shape = 15) + 
  geom_errorbarh(aes(xmin = ci_low, xmax = ci_high), height = 0.25) + 
  geom_vline(xintercept = 1, linetype = 2, colour = "grey60") + 
  scale_x_log10(limits = c(0.9, 1.4), breaks = c(0.9, 1, 1.2,  1.4),
                expand = c(0.01, 0.01)) + 
  labs(x = "OR for trend (95% CI)", title = "B") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        #plot.margin = margin(r = 0, unit = "pt"),
        panel.grid.major.y = element_line(linetype = 2, colour = "grey80")) 

plot_2.2 <- ggplot(data = res_2) + 
  geom_text(aes(x= factor(1), y = variable, label = comb_ci)) + 
  labs(x = " ", title = "OR for trend (95% CI)") + 
  theme_classic() + 
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.line.y = element_blank(),
        axis.ticks.y = element_blank(),
        #plot.margin = margin(l = 0, unit = "pt"),
        axis.text.x = element_text(colour = "white"),
        axis.line.x = element_line(colour = "white"),
        axis.ticks.x = element_line(colour = "white"),
        plot.title = element_text(hjust = 0.5, face = "bold"))


grid.arrange(plot_1.1, plot_1.2,
             plot_2.1, plot_2.2,
             layout_matrix = matrix(c(1, 1,1,1,  2,  
                                      3, 3,3,3, 4), nrow = 2, byrow = TRUE)) 

#11.5, 5.8             


#regression on diff-----
reg <- lm(mean ~ psy + gmp  + I(ppp/1000) + exp_gpd + I(-bed), 
          data = dat_reg_diff)
summary(reg)
car::vif(reg)

reg_all <- reg_comb(reg = reg,
                    data = NULL,
                    p_value = "`Pr(>|t|)`",
                    round_ci = 2,
                    comb_ci = "coef(ci_low, ci_high)")
write.csv(reg_all, "reg_diff.csv")


ggplot(data = dat_reg, aes(x = exp_gpd, y = mean, colour = start)) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  geom_hline(yintercept = 0, linetype = 2) + 
  geom_vline(xintercept = 0, linetype = 2) + 
  scale_color_manual(values = pal_nejm("default")(8)[c(2, 1)])


dat_reg<- dat_reg %>% arrange(dosage)
dat_plot <- dat_reg %>% 
  mutate(country = factor(country, levels = dat_reg$country[dat_reg$start == "End"]))

ggplot(data = dat_plot, 
       aes(x = country, y = dosage, colour = start)) + 
  geom_point() + 
  scale_color_manual(values = pal_nejm("default")(8)[c(2, 1)])





#description--------------
dat_des <- dat_final %>% filter(depression) %>% select(country, age, age_c, gender, wealth, difficult_yes, start)

set.seed(1234)
imd <- mice(dat_des, m = 1)
dat_des <- complete(imd)

res_des <- data_des(data = dat_des %>% filter(start == FALSE),
                    col_var = "country",
                    row_var = c("age_c", "gender", "wealth", "difficult_yes"))







